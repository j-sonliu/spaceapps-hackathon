<html>
    <head>
        <link rel='stylesheet' href='https://aladin.u-strasbg.fr/AladinLite/api/v2/latest/aladin.min.css' />
        <script type='text/javascript' src='https://code.jquery.com/jquery-1.9.1.min.js' charset='utf-8'></script>
    </head>
    <body>
        <div id='aladin-lite-div' style='width: 500px;height: 500px;'></div>
        <script type='text/javascript' src='https://aladin.u-strasbg.fr/AladinLite/api/v2/latest/aladin.min.js' charset='utf-8'></script>
        <script>
            /* function getSources (catalog) {
                return catalog;
                return catalog.sources;
                if (catalog.sources[1000]) {
                    console.log(catalog.sources);
                } else {
                    setTimeout(getSources, 500);
                }
            } */
            async function prepareData () {
                let aladin = A.aladin('#aladin-lite-div', {target: 'M 45', fov: 5});
                let rawSNeCatalog = await A.catalogFromURL('https://vizier.unistra.fr/viz-bin/votable?-source=B/sn/sncat&-c=galactic%20center&-out.max=9999&-out.add=EpMax&-c.rd=180', {onClick: 'showPopup'});
                let rawGRBCatalog = await A.catalogFromVizieR('IX/51/table2', 'galactic center', 180, {onClick: 'showPopup'});
                await aladin.addCatalog(rawSNeCatalog);
                await aladin.addCatalog(rawGRBCatalog);
                console.log(rawSNeCatalog);
                let SNeCatalog = await sortByTime(prepareSNeData(rawSNeCatalog, 1990, 2014), true);
                let GRBCatalog = await sortByTime(rawGRBCatalog, false);
                return {SNe: SNeCatalog, GRB: GRBCatalog};
            }
            function parseTime (timeStr) {
                let year = parseInt(timeStr.substr(0, 4)) - 1990;
                let month = parseInt(timeStr.substr(5, 2));
                let day = parseInt(timeStr.substr(8, 2));
                console.log(year);
                return 365*year + 30*month + day;
            }
            function prepareSNeData (catalog, start, end) {
                let newSources = A.catalog({onClick: 'showPopup'});
                for (const source of catalog.sources) {
                    let time = parseInt(source.data.EpMax.substr(0, 4));
                    if (time >= start && time <= end) {
                        newSources.addSources(source);
                    }
                }
                return newSources;
            }
            function sortByTime (catalog, SRe) {
                console.log(catalog.sources);
                console.log(catalog.sources.sort(function(a, b){
                    if (SRe) {
                        let aTime = parseTime(a.data.EpMax);
                        let bTime = parseTime(b.data.EpMax);
                    } else {
                        let aTime = parseTime(a.data.Date);
                        let bTime = parseTime(b.data.Date);
                    }
                    if (aTime < bTime) {
                        return -1;
                    } else if (aTime > bTime) {
                        return 1;
                    }
                    return 0;
                }));
                return catalog;
            }
            var catalogs = prepareData();
            console.log(catalogs);
        </script>
    </body>
</html>